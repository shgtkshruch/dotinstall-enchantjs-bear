!function(t,e){"function"!=typeof Object.defineProperty&&(Object.defineProperty=function(t,e,i){return"value"in i&&(t[e]=i.value),"get"in i&&t.__defineGetter__(e,i.get),"set"in i&&t.__defineSetter__(e,i.set),t}),"function"!=typeof Object.defineProperties&&(Object.defineProperties=function(t,e){for(var i in e)e.hasOwnProperty(i)&&Object.defineProperty(t,i,e[i]);return t}),"function"!=typeof Object.create&&(Object.create=function(t,e){function i(){}i.prototype=t;var n=new i;return null!=e&&Object.defineProperties(n,e),n}),"function"!=typeof Object.getPrototypeOf&&(Object.getPrototypeOf=function(t){return t.__proto__}),"function"!=typeof Function.prototype.bind&&(Function.prototype.bind=function(e){var i=this,n=Array.prototype.slice.call(arguments,1),s=function(){},r=function(){var r=n.concat(Array.prototype.slice.call(arguments));return i.apply(this instanceof s?this:e||t,r)};return s.prototype=i.prototype,r.prototype=new s,r}),t.getTime=function(){return t.performance&&t.performance.now?function(){return t.performance.now()}:t.performance&&t.performance.webkitNow?function(){return t.performance.webkitNow()}:Date.now}(),t.requestAnimationFrame=t.requestAnimationFrame||t.mozRequestAnimationFrame||t.webkitRequestAnimationFrame||t.msRequestAnimationFrame||function(){var e=t.getTime(),i=1e3/60;return function(n){var s=t.getTime(),r=setTimeout(function(){n(t.getTime())},Math.max(0,e+i-s));return e=s,r}}();var i=function(e){if(null!=e&&(e instanceof Array||(e=Array.prototype.slice.call(arguments)),e=e.filter(function(t){return[t].join()})),function n(i,s){var r,a,o=[];for(var h in i)i.hasOwnProperty(h)&&("function"==typeof i[h]?t[h]=i[h]:"object"==typeof i[h]&&Object.getPrototypeOf(i[h])===Object.prototype&&(null==e?o.push(h):(r=e.indexOf(s+h),r!==-1&&(o.push(h),e.splice(r,1)))));for(r=0,a=o.length;r<a;r++)n(i[o[r]],s+o[r]+".")}(i,""),t.Game=t.Core,null!=e&&e.length)throw new Error("Cannot load module: "+e.join(", "))};t.enchant=i,t.addEventListener("message",function(t,e){try{var n=JSON.parse(t.data);if("event"===n.type)i.Core.instance.dispatchEvent(new i.Event(n.value));else if("debug"===n.type)switch(n.value){case"start":i.Core.instance.start();break;case"pause":i.Core.instance.pause();break;case"resume":i.Core.instance.resume();break;case"tick":i.Core.instance._tick()}}catch(s){}},!1),i.Class=function(t,e){return i.Class.create(t,e)},i.Class.create=function(t,e){if(null==t&&e)throw new Error("superclass is undefined (enchant.Class.create)");if(null==t)throw new Error("definition is undefined (enchant.Class.create)");if(0===arguments.length)return i.Class.create(Object,e);if(1===arguments.length&&"function"!=typeof arguments[0])return i.Class.create(Object,arguments[0]);for(var n in e)e.hasOwnProperty(n)&&("object"==typeof e[n]&&null!==e[n]&&Object.getPrototypeOf(e[n])===Object.prototype?"enumerable"in e[n]||(e[n].enumerable=!0):e[n]={value:e[n],enumerable:!0,writable:!0});var s=function(){return this instanceof s?void s.prototype.initialize.apply(this,arguments):new s};s.prototype=Object.create(t.prototype,e),s.prototype.constructor=s,null==s.prototype.initialize&&(s.prototype.initialize=function(){t.apply(this,arguments)});for(var r=this.getInheritanceTree(t),a=r.length-1;a>=0;a--)if("function"==typeof r[a]._inherited){r[a]._inherited(s);break}return s},i.Class.getInheritanceTree=function(t){for(var e=[],i=t,n=i.prototype;i!==Object;)e.push(i),n=Object.getPrototypeOf(n),i=n.constructor;return e},i.ENV={VERSION:"0.6.1",VENDOR_PREFIX:function(){var t=navigator.userAgent;return t.indexOf("Opera")!==-1?"O":t.indexOf("MSIE")!==-1?"ms":t.indexOf("WebKit")!==-1?"webkit":"Gecko"===navigator.product?"Moz":""}(),TOUCH_ENABLED:function(){var t=document.createElement("div");return t.setAttribute("ontouchstart","return"),"function"==typeof t.ontouchstart}(),RETINA_DISPLAY:function(){if(navigator.userAgent.indexOf("iPhone")!==-1&&2===t.devicePixelRatio){var e=document.querySelector('meta[name="viewport"]');return null==e&&(e=document.createElement("meta"),document.head.appendChild(e)),e.setAttribute("content","width=640"),!0}return!1}(),USE_FLASH_SOUND:function(){var t=navigator.userAgent,e=navigator.vendor||"";return 0===location.href.indexOf("http")&&t.indexOf("Mobile")===-1&&e.indexOf("Apple")!==-1}(),USE_DEFAULT_EVENT_TAGS:["input","textarea","select","area"],CANVAS_DRAWING_METHODS:["putImageData","drawImage","drawFocusRing","fill","stroke","clearRect","fillRect","strokeRect","fillText","strokeText"],KEY_BIND_TABLE:{37:"left",38:"up",39:"right",40:"down"},PREVENT_DEFAULT_KEY_CODES:[37,38,39,40,32],SOUND_ENABLED_ON_MOBILE_SAFARI:!1,USE_WEBAUDIO:function(){return"file:"!==location.protocol}(),USE_ANIMATION:!0},i.Event=i.Class.create({initialize:function(t){this.type=t,this.target=null,this.x=0,this.y=0,this.localX=0,this.localY=0},_initPosition:function(t,e){var n=i.Core.instance;this.x=this.localX=(t-n._pageX)/n.scale,this.y=this.localY=(e-n._pageY)/n.scale}}),i.Event.LOAD="load",i.Event.PROGRESS="progress",i.Event.ENTER_FRAME="enterframe",i.Event.EXIT_FRAME="exitframe",i.Event.ENTER="enter",i.Event.EXIT="exit",i.Event.CHILD_ADDED="childadded",i.Event.ADDED="added",i.Event.ADDED_TO_SCENE="addedtoscene",i.Event.CHILD_REMOVED="childremoved",i.Event.REMOVED="removed",i.Event.REMOVED_FROM_SCENE="removedfromscene",i.Event.TOUCH_START="touchstart",i.Event.TOUCH_MOVE="touchmove",i.Event.TOUCH_END="touchend",i.Event.RENDER="render",i.Event.INPUT_START="inputstart",i.Event.INPUT_CHANGE="inputchange",i.Event.INPUT_END="inputend",i.Event.LEFT_BUTTON_DOWN="leftbuttondown",i.Event.LEFT_BUTTON_UP="leftbuttonup",i.Event.RIGHT_BUTTON_DOWN="rightbuttondown",i.Event.RIGHT_BUTTON_UP="rightbuttonup",i.Event.UP_BUTTON_DOWN="upbuttondown",i.Event.UP_BUTTON_UP="upbuttonup",i.Event.DOWN_BUTTON_DOWN="downbuttondown",i.Event.DOWN_BUTTON_UP="downbuttonup",i.Event.A_BUTTON_DOWN="abuttondown",i.Event.A_BUTTON_UP="abuttonup",i.Event.B_BUTTON_DOWN="bbuttondown",i.Event.B_BUTTON_UP="bbuttonup",i.Event.ADDED_TO_TIMELINE="addedtotimeline",i.Event.REMOVED_FROM_TIMELINE="removedfromtimeline",i.Event.ACTION_START="actionstart",i.Event.ACTION_END="actionend",i.Event.ACTION_TICK="actiontick",i.Event.ACTION_ADDED="actionadded",i.Event.ACTION_REMOVED="actionremoved",i.EventTarget=i.Class.create({initialize:function(){this._listeners={}},addEventListener:function(t,e){var i=this._listeners[t];null==i?this._listeners[t]=[e]:i.indexOf(e)===-1&&i.unshift(e)},on:function(){this.addEventListener.apply(this,arguments)},removeEventListener:function(t,e){var i=this._listeners[t];if(null!=i){var n=i.indexOf(e);n!==-1&&i.splice(n,1)}},clearEventListener:function(t){null!=t?delete this._listeners[t]:this._listeners={}},dispatchEvent:function(t){t.target=this,t.localX=t.x-this._offsetX,t.localY=t.y-this._offsetY,null!=this["on"+t.type]&&this["on"+t.type](t);var e=this._listeners[t.type];if(null!=e){e=e.slice();for(var i=0,n=e.length;i<n;i++)e[i].call(this,t)}}}),function(){var e;i.Core=i.Class.create(i.EventTarget,{initialize:function(n,s){if(null===t.document.body)throw new Error("document.body is null. Please excute 'new Core()' in window.onload.");i.EventTarget.call(this);var r=!0;e&&(r=!1,e.stop()),e=i.Core.instance=this,this.width=n||320,this.height=s||320,this.scale=1;var a=document.getElementById("enchant-stage");if(a){var o=t.getComputedStyle(a);for(n=parseInt(o.width,10),s=parseInt(o.height,10),n&&s?this.scale=Math.min(n/this.width,s/this.height):(a.style.width=this.width+"px",a.style.height=this.height+"px");a.firstChild;)a.removeChild(a.firstChild);a.style.position="relative";var h=a.getBoundingClientRect();this._pageX=Math.round(t.scrollX||t.pageXOffset+h.left),this._pageY=Math.round(t.scrollY||t.pageYOffset+h.top)}else a=document.createElement("div"),a.id="enchant-stage",a.style.position="absolute",document.body.firstChild?document.body.insertBefore(a,document.body.firstChild):document.body.appendChild(a),this.scale=Math.min(t.innerWidth/this.width,t.innerHeight/this.height),this._pageX=0,this._pageY=0;this.scale||(this.scale=1),a.style.fontSize="12px",a.style.webkitTextSizeAdjust="none",this._element=a,this.fps=30,this.frame=0,this.ready=!1,this.running=!1,this.assets={};var c=this._assets=[];!function p(t){t.assets instanceof Array&&[].push.apply(c,t.assets);for(var e in t)t.hasOwnProperty(e)&&"object"==typeof t[e]&&Object.getPrototypeOf(t[e])===Object.prototype&&p(t[e])}(i),this._scenes=[],this.currentScene=null,this.rootScene=new i.Scene,this.pushScene(this.rootScene),this.loadingScene=new i.Scene,this.loadingScene.backgroundColor="#000";var d=.4*this.width|0,l=.05*this.width|0,u=.03*d|0,f=new i.Sprite(d,l);f.x=(this.width-d)/2,f.y=(this.height-l)/2;var _=new i.Surface(d,l);_.context.fillStyle="#fff",_.context.fillRect(0,0,d,l),_.context.fillStyle="#000",_.context.fillRect(u,u,d-2*u,l-2*u),f.image=_;var v=0,m=0;this.addEventListener("progress",function(t){v=t.loaded/t.total}),f.addEventListener("enterframe",function(){m*=.9,m+=.1*v,_.context.fillStyle="#fff",_.context.fillRect(u,0,(d-2*u)*m,l)}),this.loadingScene.addChild(f),this._mousedownID=0,this._surfaceID=0,this._soundID=0,this._activated=!1,this._offsetX=0,this._offsetY=0,this.input={},i.ENV.KEY_BIND_TABLE||(i.ENV.KEY_BIND_TABLE={}),this._keybind=i.ENV.KEY_BIND_TABLE,this.pressedKeysNum=0,this._internalButtondownListeners={},this._internalButtonupListeners={};for(var E in this._keybind)this.keybind(E,this._keybind[E]);if(r){a=i.Core.instance._element;var g;document.addEventListener("keydown",function(t){if(e.dispatchEvent(new i.Event("keydown")),i.ENV.PREVENT_DEFAULT_KEY_CODES.indexOf(t.keyCode)!==-1&&(t.preventDefault(),t.stopPropagation()),e.running){var n=e._keybind[t.keyCode];n&&(g=new i.Event(n+"buttondown"),e.dispatchEvent(g))}},!0),document.addEventListener("keyup",function(t){if(e.running){var n=e._keybind[t.keyCode];n&&(g=new i.Event(n+"buttonup"),e.dispatchEvent(g))}},!0),i.ENV.TOUCH_ENABLED&&(a.addEventListener("touchstart",function(t){var n=t.target.tagName.toLowerCase();i.ENV.USE_DEFAULT_EVENT_TAGS.indexOf(n)===-1&&(t.preventDefault(),e.running||t.stopPropagation())},!0),a.addEventListener("touchmove",function(t){var n=t.target.tagName.toLowerCase();i.ENV.USE_DEFAULT_EVENT_TAGS.indexOf(n)===-1&&(t.preventDefault(),e.running||t.stopPropagation())},!0),a.addEventListener("touchend",function(t){var n=t.target.tagName.toLowerCase();i.ENV.USE_DEFAULT_EVENT_TAGS.indexOf(n)===-1&&(t.preventDefault(),e.running||t.stopPropagation())},!0)),a.addEventListener("mousedown",function(t){var n=t.target.tagName.toLowerCase();i.ENV.USE_DEFAULT_EVENT_TAGS.indexOf(n)===-1&&(t.preventDefault(),e._mousedownID++,e.running||t.stopPropagation())},!0),a.addEventListener("mousemove",function(t){var n=t.target.tagName.toLowerCase();i.ENV.USE_DEFAULT_EVENT_TAGS.indexOf(n)===-1&&(t.preventDefault(),e.running||t.stopPropagation())},!0),a.addEventListener("mouseup",function(t){var n=t.target.tagName.toLowerCase();i.ENV.USE_DEFAULT_EVENT_TAGS.indexOf(n)===-1&&(t.preventDefault(),e.running||t.stopPropagation())},!0),e._touchEventTarget={},i.ENV.TOUCH_ENABLED&&(a.addEventListener("touchstart",function(t){for(var e,n,s=i.Core.instance,r=new i.Event(i.Event.TOUCH_START),a=t.changedTouches,o=0,h=a.length;o<h;o++)e=a[o],r._initPosition(e.pageX,e.pageY),n=s.currentScene._determineEventTarget(r),s._touchEventTarget[e.identifier]=n,n.dispatchEvent(r)},!1),a.addEventListener("touchmove",function(t){for(var e,n,s=i.Core.instance,r=new i.Event(i.Event.TOUCH_MOVE),a=t.changedTouches,o=0,h=a.length;o<h;o++)e=a[o],n=s._touchEventTarget[e.identifier],n&&(r._initPosition(e.pageX,e.pageY),n.dispatchEvent(r))},!1),a.addEventListener("touchend",function(t){for(var e,n,s=i.Core.instance,r=new i.Event(i.Event.TOUCH_END),a=t.changedTouches,o=0,h=a.length;o<h;o++)e=a[o],n=s._touchEventTarget[e.identifier],n&&(r._initPosition(e.pageX,e.pageY),n.dispatchEvent(r),delete s._touchEventTarget[e.identifier])},!1)),a.addEventListener("mousedown",function(t){var e=i.Core.instance,n=new i.Event(i.Event.TOUCH_START);n._initPosition(t.pageX,t.pageY);var s=e.currentScene._determineEventTarget(n);e._touchEventTarget[e._mousedownID]=s,s.dispatchEvent(n)},!1),a.addEventListener("mousemove",function(t){var e=i.Core.instance,n=new i.Event(i.Event.TOUCH_MOVE);n._initPosition(t.pageX,t.pageY);var s=e._touchEventTarget[e._mousedownID];s&&s.dispatchEvent(n)},!1),a.addEventListener("mouseup",function(t){var e=i.Core.instance,n=new i.Event(i.Event.TOUCH_END);n._initPosition(t.pageX,t.pageY),e._touchEventTarget[e._mousedownID].dispatchEvent(n),delete e._touchEventTarget[e._mousedownID]},!1)}},preload:function(t){t instanceof Array||(t=Array.prototype.slice.call(arguments)),[].push.apply(this._assets,t)},load:function(t,n){null==n&&(n=function(){});var s=i.Core.findExt(t);if(i.Core._loadFuncs[s])i.Core._loadFuncs[s].call(this,t,n,s);else{var r=new XMLHttpRequest;r.open("GET",t,!0),r.onreadystatechange=function(s){if(4===r.readyState){if(200!==r.status&&0!==r.status)throw new Error(r.status+": Cannot load an asset: "+t);var a=r.getResponseHeader("Content-Type")||"";a.match(/^image/)?(e.assets[t]=i.Surface.load(t),e.assets[t].addEventListener("load",n)):a.match(/^audio/)?(e.assets[t]=i.Sound.load(t,a),e.assets[t].addEventListener("load",n)):(e.assets[t]=r.responseText,n())}},r.send(null)}},start:function(){var t=function(){this.currentTime=this.getTime(),this._nextTime=0,this.removeEventListener("load",t),this.running=!0,this.ready=!0,this._requestNextFrame()};if(this.addEventListener("load",t),!this._activated&&this._assets.length){if(this._activated=!0,i.Sound.enabledInMobileSafari&&!e._touched&&"webkit"===i.ENV.VENDOR_PREFIX&&i.ENV.TOUCH_ENABLED){var n=new i.Scene;n.backgroundColor="#000";var s=Math.round(e.width/10),r=new i.Sprite(e.width,s);r.y=(e.height-s)/2,r.image=new i.Surface(e.width,s),r.image.context.fillStyle="#fff",r.image.context.font=s-1+"px bold Helvetica,Arial,sans-serif";var a=r.image.context.measureText("Touch to Start").width;return r.image.context.fillText("Touch to Start",(e.width-a)/2,s-1),n.addChild(r),document.addEventListener("touchstart",function(){e._touched=!0,e.removeScene(n),e.start()},!0),void e.pushScene(n)}for(var o={},h=(this._assets.filter(function(t){return!(t in o)&&(o[t]=!0)})),c=0,d=h.length,l=function(){var t=new i.Event("progress");t.loaded=++c,t.total=d,e.dispatchEvent(t),c===d&&(e.removeScene(e.loadingScene),e.dispatchEvent(new i.Event("load")))},u=0;u<d;u++)this.load(h[u],l);this.pushScene(this.loadingScene)}else this.dispatchEvent(new i.Event("load"))},debug:function(){this._debug=!0,this.start()},actualFps:{get:function(){return this._actualFps||this.fps}},_requestNextFrame:function(){if(this.ready){var e=this;t.requestAnimationFrame(e._checkTick)}},_checkTick:function(e){var n=i.Core.instance;n._nextTime<e?n._tick(e):t.requestAnimationFrame(n._checkTick)},_tick:function(t){var e=new i.Event("enterframe");e.elapsed=t-this.currentTime,this._nextTime=t+1e3/this.fps,this._actualFps=e.elapsed>0?1e3/e.elapsed:0;for(var n=this.currentScene.childNodes.slice(),s=Array.prototype.push;n.length;){var r=n.pop();r.age++,r.dispatchEvent(e),r.childNodes&&s.apply(n,r.childNodes)}this.currentScene.age++,this.currentScene.dispatchEvent(e),this.dispatchEvent(e),this.dispatchEvent(new i.Event("exitframe")),this.frame++,this._requestNextFrame()},getTime:function(){return t.getTime()},stop:function(){this.ready=!1,this.running=!1},pause:function(){this.ready=!1},resume:function(){this.ready||(this.currentTime=this.getTime(),this.ready=!0,this.running=!0,this._requestNextFrame())},pushScene:function(t){return this._element.appendChild(t._element),this.currentScene&&this.currentScene.dispatchEvent(new i.Event("exit")),this.currentScene=t,this.currentScene.dispatchEvent(new i.Event("enter")),this._scenes.push(t)},popScene:function(){return this.currentScene===this.rootScene?this.currentScene:(this._element.removeChild(this.currentScene._element),this.currentScene.dispatchEvent(new i.Event("exit")),this.currentScene=this._scenes[this._scenes.length-2],this.currentScene.dispatchEvent(new i.Event("enter")),this._scenes.pop())},replaceScene:function(t){return this.popScene(),this.pushScene(t)},removeScene:function(t){if(this.currentScene===t)return this.popScene();var e=this._scenes.indexOf(t);return e!==-1?(this._scenes.splice(e,1),this._element.removeChild(t._element),t):null},keybind:function(t,e){this._keybind[t]=e;var n=function(t){var n;this.input[e]||(this.input[e]=!0,n=new i.Event(this.pressedKeysNum++?"inputchange":"inputstart"),this.dispatchEvent(n),this.currentScene.dispatchEvent(n)),this.currentScene.dispatchEvent(t)},s=function(t){var n;this.input[e]&&(this.input[e]=!1,n=new i.Event(--this.pressedKeysNum?"inputchange":"inputend"),this.dispatchEvent(n),this.currentScene.dispatchEvent(n)),this.currentScene.dispatchEvent(t)};this.addEventListener(e+"buttondown",n),this.addEventListener(e+"buttonup",s),this._internalButtondownListeners[t]=n,this._internalButtonupListeners[t]=s},keyunbind:function(t){if(this._keybind[t]){var e=this._internalButtondownListeners,i=this._internalButtonupListeners;this.removeEventListener(t+"buttondown",e),this.removeEventListener(t+"buttonup",i),delete e[t],delete i[t],delete this._keybind[t]}},getElapsedTime:function(){return this.frame/this.fps}}),i.Core._loadFuncs={},i.Core._loadFuncs.jpg=i.Core._loadFuncs.jpeg=i.Core._loadFuncs.gif=i.Core._loadFuncs.png=i.Core._loadFuncs.bmp=function(t,e){this.assets[t]=i.Surface.load(t),this.assets[t].addEventListener("load",e)},i.Core._loadFuncs.mp3=i.Core._loadFuncs.aac=i.Core._loadFuncs.m4a=i.Core._loadFuncs.wav=i.Core._loadFuncs.ogg=function(t,e,n){this.assets[t]=i.Sound.load(t,"audio/"+n,e)},i.Core.findExt=function(t){var e=t.match(/\.\w+$/);return e&&e.length>0?e[0].slice(1).toLowerCase():0===t.indexOf("data:")?t.split(/[\/;]/)[1].toLowerCase():null},i.Core.instance=null}(),i.Game=i.Core,i.Node=i.Class.create(i.EventTarget,{initialize:function(){if(i.EventTarget.call(this),this._dirty=!1,this._matrix=[1,0,0,1,0,0],this._x=0,this._y=0,this._offsetX=0,this._offsetY=0,this.age=0,this.parentNode=null,this.scene=null,this.addEventListener("touchstart",function(t){this.parentNode&&this.parentNode.dispatchEvent(t)}),this.addEventListener("touchmove",function(t){this.parentNode&&this.parentNode.dispatchEvent(t)}),this.addEventListener("touchend",function(t){this.parentNode&&this.parentNode.dispatchEvent(t)}),i.ENV.USE_ANIMATION){this.tl=new i.Timeline(this)}},moveTo:function(t,e){this._x=t,this._y=e,this._dirty=!0},moveBy:function(t,e){this._x+=t,this._y+=e,this._dirty=!0},x:{get:function(){return this._x},set:function(t){this._x=t,this._dirty=!0}},y:{get:function(){return this._y},set:function(t){this._y=t,this._dirty=!0}},_updateCoordinate:function(){var t=this,e=[t],n=t.parentNode;for(this.scene;n&&t._dirty;)e.unshift(n),t=t.parentNode,n=t.parentNode;var s,r,a,o=i.Matrix.instance,h=o.stack,c=[];h.push(e[0]._matrix);for(var d=1,l=e.length;d<l;d++){t=e[d],s=[],o.makeTransformMatrix(t,c),o.multiply(h[h.length-1],c,s),t._matrix=s,h.push(s),r="number"==typeof t._originX?t._originX:t._width/2||0,a="number"==typeof t._originY?t._originY:t._height/2||0;var u=[r,a];o.multiplyVec(s,u,u),t._offsetX=u[0]-r,t._offsetY=u[1]-a,t._dirty=!1}o.reset()},remove:function(){this._listener&&this.clearEventListener(),this.parentNode&&this.parentNode.removeChild(this)}});var n=function(t,e){for(var i,n=[],s=0,r=t.collection.length;s<r;s++)i=t.collection[s],e._intersectone(i)&&n.push(i);return n},s=function(t,e){for(var i,n,s=[],r=0,a=t.collection.length;r<a;r++){i=t.collection[r];for(var o=0,h=e.collection.length;o<h;o++)n=e.collection[o],i._intersectone(n)&&s.push([i,n])}return s},r=function(t){return t instanceof i.Entity?n(this,t):!("function"!=typeof t||!t.collection)&&s(this,t)};i.Entity=i.Class.create(i.Node,{initialize:function(){var t=i.Core.instance;i.Node.call(this),this._rotation=0,this._scaleX=1,this._scaleY=1,this._touchEnabled=!0,this._clipping=!1,this._originX=null,this._originY=null,this._width=0,this._height=0,this._backgroundColor=null,this._opacity=1,this._visible=!0,this._buttonMode=null,this._style={},this.__styleStatus={},this.compositeOperation=null,this.buttonMode=null,this.buttonPressed=!1,this.addEventListener("touchstart",function(){if(this.buttonMode){this.buttonPressed=!0;var e=new i.Event(this.buttonMode+"buttondown");this.dispatchEvent(e),t.dispatchEvent(e)}}),this.addEventListener("touchend",function(){if(this.buttonMode){this.buttonPressed=!1;var e=new i.Event(this.buttonMode+"buttonup");this.dispatchEvent(e),t.dispatchEvent(e)}}),this.enableCollection()},width:{get:function(){return this._width},set:function(t){this._width=t,this._dirty=!0}},height:{get:function(){return this._height},set:function(t){this._height=t,this._dirty=!0}},backgroundColor:{get:function(){return this._backgroundColor},set:function(t){this._backgroundColor=t}},opacity:{get:function(){return this._opacity},set:function(t){this._opacity=parseFloat(t)}},visible:{get:function(){return this._visible},set:function(t){this._visible=t}},touchEnabled:{get:function(){return this._touchEnabled},set:function(t){this._touchEnabled=t,(this._touchEnabled=t)?this._style.pointerEvents="all":this._style.pointerEvents="none"}},intersect:function(t){return t instanceof i.Entity?this._intersectone(t):!("function"!=typeof t||!t.collection)&&n(t,this)},_intersectone:function(t){return this._dirty&&this._updateCoordinate(),t._dirty&&t._updateCoordinate(),this._offsetX<t._offsetX+t.width&&t._offsetX<this._offsetX+this.width&&this._offsetY<t._offsetY+t.height&&t._offsetY<this._offsetY+this.height},within:function(t,e){this._dirty&&this._updateCoordinate(),t._dirty&&t._updateCoordinate(),null==e&&(e=(this.width+this.height+t.width+t.height)/4);var i;return(i=this._offsetX-t._offsetX+(this.width-t.width)/2)*i+(i=this._offsetY-t._offsetY+(this.height-t.height)/2)*i<e*e},scale:function(t,e){this._scaleX*=t,this._scaleY*=null!=e?e:t,this._dirty=!0},rotate:function(t){this._rotation+=t,this._dirty=!0},scaleX:{get:function(){return this._scaleX},set:function(t){this._scaleX=t,this._dirty=!0}},scaleY:{get:function(){return this._scaleY},set:function(t){this._scaleY=t,this._dirty=!0}},rotation:{get:function(){return this._rotation},set:function(t){this._rotation=t,this._dirty=!0}},originX:{get:function(){return this._originX},set:function(t){this._originX=t,this._dirty=!0}},originY:{get:function(){return this._originY},set:function(t){this._originY=t,this._dirty=!0}},enableCollection:function(){this.addEventListener("addedtoscene",this._addSelfToCollection),this.addEventListener("removedfromscene",this._removeSelfFromCollection),this.scene&&this._addSelfToCollection()},disableCollection:function(){this.removeEventListener("addedtoscene",this._addSelfToCollection),this.removeEventListener("removedfromscene",this._removeSelfFromCollection),this.scene&&this._removeSelfFromCollection()},_addSelfToCollection:function(){var t=this.getConstructor();t._collectionTarget.forEach(function(t){t.collection.push(this)},this)},_removeSelfFromCollection:function(){var t=this.getConstructor();t._collectionTarget.forEach(function(t){var e=t.collection.indexOf(this);e!==-1&&t.collection.splice(e,1)},this)},getConstructor:function(){return Object.getPrototypeOf(this).constructor}});var a=function(t){if(!t._collective){var e=i.Class.getInheritanceTree(t),n=e.indexOf(i.Entity);n!==-1?t._collectionTarget=e.splice(0,n+1):t._collectionTarget=[],t.intersect=r,t.collection=[],t._collective=!0}};a(i.Entity),i.Entity._inherited=function(t){a(t)},i.Sprite=i.Class.create(i.Entity,{initialize:function(t,e){i.Entity.call(this),this.width=t,this.height=e,this._image=null,this._frameLeft=0,this._frameTop=0,this._frame=0,this._frameSequence=[],this.addEventListener("enterframe",function(){if(0!==this._frameSequence.length){var t=this._frameSequence.shift();null===t?this._frameSequence=[]:(this._setFrame(t),this._frameSequence.push(t))}})},image:{get:function(){return this._image},set:function(t){t!==this._image&&(this._image=t,this._setFrame(this._frame))}},frame:{get:function(){return this._frame},set:function(t){if(this._frame!==t)if(t instanceof Array){var e=t,i=e.shift();this._setFrame(i),e.push(i),this._frameSequence=e}else this._setFrame(t),this._frameSequence=[],this._frame=t}},_setFrame:function(t){var e,i=this._image;null!=i&&(this._frame=t,e=i.width/this._width|0,this._frameLeft=(t%e|0)*this._width,this._frameTop=(t/e|0)*this._height%i.height)},width:{get:function(){return this._width},set:function(t){this._width=t,this._setFrame(),this._dirty=!0}},height:{get:function(){return this._height},set:function(t){this._height=t,this._setFrame(),this._dirty=!0}},cvsRender:function(t){if(null!=this._image&&0!==this._width&&0!==this._height){var e,i,n,s,r=this._image,a=r._element,o=this._frameLeft,h=this._frameTop,c=Math.min(this.width,r.width-o),d=Math.min(this.height,r.height-h),l=Math.min(r.width,this.width),u=Math.min(r.height,this.height);for(i=0;i<this.height;i+=u)for(s=this.height<i+u?this.height-i:u,e=0;e<this.width;e+=l)n=this.width<e+l?this.width-e:l,t.drawImage(a,o,h,c*n/l,d*s/u,e,i,n,s)}},domRender:function(t){this._image&&(this._image._css?(this._style["background-image"]=this._image._css,this._style["background-position"]=-this._frameLeft+"px "+-this._frameTop+"px"):this._image._element)}}),i.Label=i.Class.create(i.Entity,{initialize:function(t){i.Entity.call(this),this.width=300,this.font="14px serif",this.text=t||"",this.textAlign="left"},text:{get:function(){return this._text},set:function(t){if(this._text!==t){this._text=t,t=t.replace(/<(br|BR) ?\/?>/g,"<br/>"),this._splitText=t.split("<br/>"),this.updateBoundArea();for(var e=0,i=this._splitText.length;e<i;e++){t=this._splitText[e];var n=this.getMetrics(t);this._splitText[e]={},this._splitText[e].text=t,this._splitText[e].height=n.height}}}},textAlign:{get:function(){return this._style["text-align"]},set:function(t){this._style["text-align"]=t,this.updateBoundArea()}},font:{get:function(){return this._style.font},set:function(t){this._style.font=t,this.updateBoundArea()}},color:{get:function(){return this._style.color},set:function(t){this._style.color=t}},cvsRender:function(t){var e,i,n,s,r=0;if(this._splitText){t.textBaseline="top",t.font=this.font,t.fillStyle=this.color||"#000000";for(var a=0,o=this._splitText.length;a<o;a++){i=this._splitText[a],n="";for(var h=0,c=i.text.length;h<c;h++)s=i.text[h],t.measureText(n).width>this.width&&(t.fillText(n,0,r),r+=i.height-1,n=""),n+=s;e="right"===this.textAlign?this.width-t.measureText(n).width:"center"===this.textAlign?(this.width-t.measureText(n).width)/2:0,t.fillText(n,e,r),r+=i.height-1}}},domRender:function(t){t.innerHTML!==this._text&&(t.innerHTML=this._text)},detectRender:function(t){t.fillRect(this._boundOffset,0,this._boundWidth,this._boundHeight)},updateBoundArea:function(){var t=this.getMetrics();this._boundWidth=t.width,this._boundHeight=t.height,"right"===this.textAlign?this._boundOffset=this.width-this._boundWidth:"center"===this.textAlign?this._boundOffset=(this.width-this._boundWidth)/2:this._boundOffset=0}}),i.Label.prototype.getMetrics=function(t){var e,i={};if(document.body){e=document.createElement("div");for(var n in this._style)"width"!==n&&"height"!==n&&(e.style[n]=this._style[n]);e.innerHTML=t||this._text,document.body.appendChild(e),i.height=parseInt(getComputedStyle(e).height,10)+1,e.style.position="absolute",i.width=parseInt(getComputedStyle(e).width,10)+1,document.body.removeChild(e)}else i.width=this.width,i.height=this.height;return i},i.Map=i.Class.create(i.Entity,{initialize:function(t,e){var n=i.Core.instance;i.Entity.call(this);var s=new i.Surface(n.width,n.height);this._surface=s;var r=s._element;r.style.position="absolute",i.ENV.RETINA_DISPLAY&&2===n.scale?(r.width=2*n.width,r.height=2*n.height,this._style.webkitTransformOrigin="0 0",this._style.webkitTransform="scale(0.5)"):(r.width=n.width,r.height=n.height),this._context=r.getContext("2d"),this._tileWidth=t||0,this._tileHeight=e||0,this._image=null,this._data=[[[]]],this._dirty=!1,this._tight=!1,this.touchEnabled=!1,this.collisionData=null,this._listeners.render=null,this.addEventListener("render",function(){if(this._dirty||null==this._previousOffsetX)this.redraw(0,0,n.width,n.height);else if(this._offsetX!==this._previousOffsetX||this._offsetY!==this._previousOffsetY)if(this._tight){var t=-this._offsetX,e=-this._offsetY,i=-this._previousOffsetX,s=-this._previousOffsetY,r=t-i+n.width,a=i-t+n.width,o=e-s+n.height,h=s-e+n.height;if(r>this._tileWidth&&a>this._tileWidth&&o>this._tileHeight&&h>this._tileHeight){var c,d,l,u,f,_;r<a?(c=0,l=i-t,f=r):(c=t-i,l=0,f=a),o<h?(d=0,u=s-e,_=o):(d=e-s,u=0,_=h),null==n._buffer&&(n._buffer=document.createElement("canvas"),n._buffer.width=this._context.canvas.width,n._buffer.height=this._context.canvas.height);var v=n._buffer.getContext("2d");this._doubledImage?(v.clearRect(0,0,2*f,2*_),v.drawImage(this._context.canvas,2*c,2*d,2*f,2*_,0,0,2*f,2*_),v=this._context,v.clearRect(2*l,2*u,2*f,2*_),v.drawImage(n._buffer,0,0,2*f,2*_,2*l,2*u,2*f,2*_)):(v.clearRect(0,0,f,_),v.drawImage(this._context.canvas,c,d,f,_,0,0,f,_),v=this._context,v.clearRect(l,u,f,_),v.drawImage(n._buffer,0,0,f,_,l,u,f,_)),0===l?this.redraw(f,0,n.width-f,n.height):this.redraw(0,0,n.width-f,n.height),0===u?this.redraw(0,_,n.width,n.height-_):this.redraw(0,0,n.width,n.height-_)}else this.redraw(0,0,n.width,n.height)}else this.redraw(0,0,n.width,n.height);this._previousOffsetX=this._offsetX,this._previousOffsetY=this._offsetY})},loadData:function(t){this._data=Array.prototype.slice.apply(arguments),this._dirty=!0,this._tight=!1;for(var e=0,i=this._data.length;e<i;e++){var n=0;t=this._data[e];for(var s=0,r=t.length;s<r;s++)for(var a=0,o=t[s].length;a<o;a++)t[s][a]>=0&&n++;if(n/(t.length*t[0].length)>.2){this._tight=!0;break}}},checkTile:function(t,e){if(t<0||this.width<=t||e<0||this.height<=e)return!1;var i=this._image.width,n=this._image.height,s=this._tileWidth||i,r=this._tileHeight||n;t=t/s|0,e=e/r|0;var a=this._data[0];return a[e][t]},hitTest:function(t,e){if(t<0||this.width<=t||e<0||this.height<=e)return!1;var i=this._image.width,n=this._image.height,s=this._tileWidth||i,r=this._tileHeight||n;if(t=t/s|0,e=e/r|0,null!=this.collisionData)return this.collisionData[e]&&!!this.collisionData[e][t];for(var a=0,o=this._data.length;a<o;a++){var h,c=this._data[a];if(null!=c[e]&&null!=(h=c[e][t])&&0<=h&&h<(i/s|0)*(n/r|0))return!0}return!1},image:{get:function(){return this._image},set:function(t){var e=i.Core.instance;if(this._image=t,i.ENV.RETINA_DISPLAY&&2===e.scale){for(var n=new i.Surface(2*t.width,2*t.height),s=this._tileWidth||t.width,r=this._tileHeight||t.height,a=t.width/s|0,o=t.height/r|0,h=0;h<o;h++)for(var c=0;c<a;c++)n.draw(t,c*s,h*r,s,r,c*s*2,h*r*2,2*s,2*r);this._doubledImage=n}this._dirty=!0}},tileWidth:{get:function(){return this._tileWidth},set:function(t){this._tileWidth=t,this._dirty=!0}},tileHeight:{get:function(){return this._tileHeight},set:function(t){this._tileHeight=t,this._dirty=!0}},width:{get:function(){return this._tileWidth*this._data[0][0].length}},height:{get:function(){return this._tileHeight*this._data[0].length}},redraw:function(t,e,i,n){if(null!=this._image){var s,r,a,o,h;this._doubledImage?(s=this._doubledImage,r=2*this._tileWidth,a=2*this._tileHeight,o=2*-this._offsetX,h=2*-this._offsetY,t*=2,e*=2,i*=2,n*=2):(s=this._image,r=this._tileWidth,a=this._tileHeight,o=-this._offsetX,h=-this._offsetY);var c=s.width/r|0,d=s.height/a|0,l=Math.max((t+o)/r|0,0),u=Math.max((e+h)/a|0,0),f=Math.ceil((t+o+i)/r),_=Math.ceil((e+h+n)/a),v=s._element,m=this._context;m.canvas;m.clearRect(t,e,i,n);for(var E=0,g=this._data.length;E<g;E++){var p=this._data[E],y=Math.min(f,p[0].length),w=Math.min(_,p.length);for(e=u;e<w;e++)for(t=l;t<y;t++){var T=p[e][t];if(0<=T&&T<c*d){var C=T%c*r,N=(T/c|0)*a;m.drawImage(v,C,N,r,a,t*r-o,e*a-h,r,a)}}}}},cvsRender:function(t){var e=i.Core.instance;if(0!==this.width&&0!==this.height){t.save(),t.setTransform(1,0,0,1,0,0);
var n=this._context.canvas;t.drawImage(n,0,0,e.width,e.height),t.restore()}},domRender:function(t){this._image&&(this._style["background-image"]=this._surface._css,this._style[i.ENV.VENDOR_PREFIX+"Transform"]="matrix(1, 0, 0, 1, 0, 0)")}}),i.Group=i.Class.create(i.Node,{initialize:function(){this.childNodes=[],i.Node.call(this),this._rotation=0,this._scaleX=1,this._scaleY=1,this._originX=null,this._originY=null,this.__dirty=!1,[i.Event.ADDED_TO_SCENE,i.Event.REMOVED_FROM_SCENE].forEach(function(t){this.addEventListener(t,function(t){this.childNodes.forEach(function(e){e.scene=this.scene,e.dispatchEvent(t)},this)})},this)},addChild:function(t){this.childNodes.push(t),t.parentNode=this;var e=new i.Event("childadded");if(e.node=t,e.next=null,this.dispatchEvent(e),t.dispatchEvent(new i.Event("added")),this.scene){t.scene=this.scene;var n=new i.Event("addedtoscene");t.dispatchEvent(n)}},insertBefore:function(t,e){var n=this.childNodes.indexOf(e);if(n!==-1){this.childNodes.splice(n,0,t),t.parentNode=this;var s=new i.Event("childadded");if(s.node=t,s.next=e,this.dispatchEvent(s),t.dispatchEvent(new i.Event("added")),this.scene){t.scene=this.scene;var r=new i.Event("addedtoscene");t.dispatchEvent(r)}}else this.addChild(t)},removeChild:function(t){var e;if((e=this.childNodes.indexOf(t))!==-1){this.childNodes.splice(e,1),t.parentNode=null;var n=new i.Event("childremoved");if(n.node=t,this.dispatchEvent(n),t.dispatchEvent(new i.Event("removed")),this.scene){t.scene=null;var s=new i.Event("removedfromscene");t.dispatchEvent(s)}}},firstChild:{get:function(){return this.childNodes[0]}},lastChild:{get:function(){return this.childNodes[this.childNodes.length-1]}},rotation:{get:function(){return this._rotation},set:function(t){this._rotation=t,this._dirty=!0}},scaleX:{get:function(){return this._scaleX},set:function(t){this._scaleX=t,this._dirty=!0}},scaleY:{get:function(){return this._scaleY},set:function(t){this._scaleY=t,this._dirty=!0}},originX:{get:function(){return this._originX},set:function(t){this._originX=t,this._dirty=!0}},originY:{get:function(){return this._originY},set:function(t){this._originY=t,this._dirty=!0}},_dirty:{get:function(){return this.__dirty},set:function(t){if(t=!!t,this.__dirty=t,t)for(var e=0,i=this.childNodes.length;e<i;e++)this.childNodes[e]._dirty=!0}}}),i.Matrix=i.Class.create({initialize:function(){return i.Matrix.instance?i.Matrix.instance:void this.reset()},reset:function(){this.stack=[],this.stack.push([1,0,0,1,0,0])},makeTransformMatrix:function(t,e){var i=t._x,n=t._y,s=t.width||0,r=t.height||0,a=t._rotation||0,o="number"==typeof t._scaleX?t._scaleX:1,h="number"==typeof t._scaleY?t._scaleY:1,c=a*Math.PI/180,d=Math.cos(c),l=Math.sin(c),u="number"==typeof t._originX?t._originX:s/2,f="number"==typeof t._originY?t._originY:r/2,_=o*d,v=o*l,m=h*l,E=h*d;e[0]=_,e[1]=v,e[2]=-m,e[3]=E,e[4]=-_*u+m*f+i+u,e[5]=-v*u-E*f+n+f},multiply:function(t,e,i){var n=t[0],s=t[2],r=t[4],a=t[1],o=t[3],h=t[5],c=e[0],d=e[2],l=e[4],u=e[1],f=e[3],_=e[5];i[0]=n*c+s*u,i[1]=a*c+o*u,i[2]=n*d+s*f,i[3]=a*d+o*f,i[4]=n*l+s*_+r,i[5]=a*l+o*_+h},multiplyVec:function(t,e,i){var n=e[0],s=e[1],r=t[0],a=t[2],o=t[4],h=t[1],c=t[3],d=t[5];i[0]=r*n+a*s+o,i[1]=h*n+c*s+d}}),i.Matrix.instance=new i.Matrix,i.DetectColorManager=i.Class.create({initialize:function(t,e){this.reference=[],this.colorResolution=t||16,this.max=e||1,this.capacity=Math.pow(this.colorResolution,3);for(var i=1,n=this.capacity;i<n;i++)this.reference[i]=null},attachDetectColor:function(t){var e=this.reference.indexOf(null);return e===-1&&(e=1),this.reference[e]=t,this._getColor(e)},detachDetectColor:function(t){var e=this.reference.indexOf(t);e!==-1&&(this.reference[e]=null)},_getColor:function(t){var e=this.colorResolution,i=e/this.max;return[parseInt(t/e/e%e,10)/i,parseInt(t/e%e,10)/i,parseInt(t%e,10)/i,1]},_decodeDetectColor:function(t){var e=this.colorResolution;return~~(t[0]*e*e*e/256)+~~(t[1]*e*e/256)+~~(t[2]*e/256)},getSpriteByColor:function(t){return this.reference[this._decodeDetectColor(t)]}}),i.DomManager=i.Class.create({initialize:function(t,e){var n=i.Core.instance;this.layer=null,this.targetNode=t,"string"==typeof e?this.element=document.createElement(e):e instanceof HTMLElement&&(this.element=e),this.style=this.element.style,this.style.position="absolute",this.style[i.ENV.VENDOR_PREFIX+"TransformOrigin"]="0px 0px",n._debug&&(this.style.border="1px solid blue",this.style.margin="-1px");var s=this;this._setDomTarget=function(){s.layer._touchEventTarget=s.targetNode},this._attachEvent()},getDomElement:function(){return this.element},getDomElementAsNext:function(){return this.element},getNextManager:function(t){var e=this.targetNode.parentNode.childNodes.indexOf(t.targetNode);return e!==this.targetNode.parentNode.childNodes.length-1?this.targetNode.parentNode.childNodes[e+1]._domManager:null},addManager:function(t,e){var i;e&&(i=e.getDomElementAsNext());var n=t.getDomElement();n instanceof Array?n.forEach(function(t){this.element.insertBefore(t,i)},this):this.element.insertBefore(n,i),this.setLayer(this.layer)},removeManager:function(t){t instanceof i.DomlessManager?t._domRef.forEach(function(t){this.element.removeChild(t)},this):this.element.removeChild(t.element),this.setLayer(this.layer)},setLayer:function(t){this.layer=t;var e,i=this.targetNode;if(i.childNodes)for(var n=0,s=i.childNodes.length;n<s;n++)e=i.childNodes[n]._domManager,e&&e.setLayer(t)},render:function(t){var e=this.targetNode,n=i.Matrix.instance,s=n.stack,r=[];n.makeTransformMatrix(e,r),n.multiply(s[s.length-1],r,r),n.multiply(t,r,t),e._matrix=t;var a="number"==typeof e._originX?e._originX:e.width/2||0,o="number"==typeof e._originY?e._originY:e.height/2||0,h=[a,o];n.multiplyVec(r,h,h),e._offsetX=h[0]-a,e._offsetY=h[1]-o,!e.parentNode||e.parentNode instanceof i.Group||(e._offsetX+=e.parentNode._offsetX,e._offsetY+=e.parentNode._offsetY),this.style[i.ENV.VENDOR_PREFIX+"Transform"]="matrix("+r[0].toFixed(10)+","+r[1].toFixed(10)+","+r[2].toFixed(10)+","+r[3].toFixed(10)+","+r[4].toFixed(10)+","+r[5].toFixed(10)+")",this.domRender()},domRender:function(){var t=this.targetNode;t._style||(t._style={}),t.__styleStatus||(t.__styleStatus={}),t._style.width=t.width+"px",t._style.height=t.height+"px",t._style.opacity=t._opacity,t._style["background-color"]=t._backgroundColor,"undefined"!=typeof t._visible&&(t._style.display=t._visible?"block":"none"),"function"==typeof t.domRender&&t.domRender(this.element);for(var e in t._style)t.__styleStatus[e]!==t._style[e]&&(this.style.setProperty(e,t._style[e]),t.__styleStatus[e]=t._style[e])},_attachEvent:function(){i.ENV.TOUCH_ENABLED&&this.element.addEventListener("touchstart",this._setDomTarget,!0),this.element.addEventListener("mousedown",this._setDomTarget,!0)},_detachEvent:function(){i.ENV.TOUCH_ENABLED&&this.element.removeEventListener("touchstart",this._setDomTarget,!0),this.element.removeEventListener("mousedown",this._setDomTarget,!0)},remove:function(){this._detachEvent(),this.element=this.style=this.targetNode=null}}),i.DomlessManager=i.Class.create({initialize:function(t){this._domRef=[],this.targetNode=t},_register:function(t,e){var i=this._domRef.indexOf(e);t instanceof Array?i===-1?Array.prototype.push.apply(this._domRef,t):Array.prototype.splice.apply(this._domRef,[i,0].concat(t)):i===-1?this._domRef.push(t):this._domRef.splice(i,0,t)},getNextManager:function(t){var e=this.targetNode.parentNode.childNodes.indexOf(t.targetNode);return e!==this.targetNode.parentNode.childNodes.length-1?this.targetNode.parentNode.childNodes[e+1]._domManager:null},getDomElement:function(){var t=[];return this.targetNode.childNodes.forEach(function(e){t=t.concat(e._domManager.getDomElement())}),t},getDomElementAsNext:function(){if(this._domRef.length)return this._domRef[0];var t=this.getNextManager(this);return t?t.element:null},addManager:function(t,e){var n=this.targetNode.parentNode;n&&(null===e&&(e=this.getNextManager(this)),n instanceof i.Scene?n._layers.Dom._domManager.addManager(t,e):n._domManager.addManager(t,e));var s=e?e.getDomElementAsNext():null;this._register(t.getDomElement(),s),this.setLayer(this.layer)},removeManager:function(t){var e,i=this._domRef.indexOf(t.element);i!==-1&&(e=this._domRef[i],e.parentNode.removeChild(e),this._domRef.splice(i,1)),this.setLayer(this.layer)},setLayer:function(t){this.layer=t;var e,i=this.targetNode;if(i.childNodes)for(var n=0,s=i.childNodes.length;n<s;n++)e=i.childNodes[n]._domManager,e&&e.setLayer(t)},render:function(t){var e=i.Matrix.instance,n=e.stack,s=this.targetNode,r=[];e.makeTransformMatrix(s,r),e.multiply(n[n.length-1],r,r),e.multiply(t,r,t),s._matrix=t;var a="number"==typeof s._originX?s._originX:s.width/2||0,o="number"==typeof s._originY?s._originY:s.height/2||0,h=[a,o];e.multiplyVec(r,h,h),s._offsetX=h[0]-a,s._offsetY=h[1]-o,n.push(r)},remove:function(){this._domRef=[],this.targetNode=null}}),i.DomLayer=i.Class.create(i.Group,{initialize:function(){var t=i.Core.instance;i.Group.call(this),this.width=this._width=t.width,this.height=this._height=t.height,this._touchEventTarget=null,this._element=document.createElement("div"),this._element.style.width=this.width+"px",this._element.style.height=this.height+"px",this._element.style.position="absolute",this._domManager=new i.DomManager(this,this._element),this._domManager.layer=this;var e=[i.Event.TOUCH_START,i.Event.TOUCH_MOVE,i.Event.TOUCH_END];e.forEach(function(t){this.addEventListener(t,function(t){this._scene&&this._scene.dispatchEvent(t)})},this);var n=function(t){var e=t.node,r=t.next,a=t.target,o=r?r._domManager:null;i.DomLayer._attachDomManager(e,n,s),a._domManager.addManager(e._domManager,o);var h=new i.Event(i.Event.RENDER);e._dirty=!0,a._domManager.layer._rendering(e,h)},s=function(t){var e=t.node,r=t.target;r._domManager.removeManager(e._domManager),i.DomLayer._detachDomManager(e,n,s)};this.addEventListener("childremoved",s),this.addEventListener("childadded",n)},_startRendering:function(){this.addEventListener("exitframe",this._onexitframe),this._onexitframe()},_stopRendering:function(){this.removeEventListener("exitframe",this._onexitframe),this._onexitframe()},_onexitframe:function(){this._rendering(this,new i.Event(i.Event.RENDER))},_rendering:function(t,e,n){var s;if(n||(n=[1,0,0,1,0,0]),t.dispatchEvent(e),t._domManager.render(n),t.childNodes)for(var r=0,a=t.childNodes.length;r<a;r++)s=t.childNodes[r],this._rendering(s,e,n.slice());t._domManager instanceof i.DomlessManager&&i.Matrix.instance.stack.pop(),t._dirty=!1},_determineEventTarget:function(){return this._touchEventTarget&&this._touchEventTarget!==this?this._touchEventTarget:null}}),i.DomLayer._attachDomManager=function(t,e,n){var s;if(t._domManager||(t.addEventListener("childadded",e),t.addEventListener("childremoved",n),t instanceof i.Group?t._domManager=new i.DomlessManager(t):t._element?t._domManager=new i.DomManager(t,t._element):t._domManager=new i.DomManager(t,"div")),t.childNodes)for(var r=0,a=t.childNodes.length;r<a;r++)s=t.childNodes[r],i.DomLayer._attachDomManager(s,e,n),t._domManager.addManager(s._domManager,null)},i.DomLayer._detachDomManager=function(t,e,n){var s;if(t.removeEventListener("childadded",e),t.removeEventListener("childremoved",n),t.childNodes)for(var r=0,a=t.childNodes.length;r<a;r++)s=t.childNodes[r],t._domManager.removeManager(s._domManager,null),i.DomLayer._detachDomManager(s,e,n);t._domManager.remove(),delete t._domManager},i.CanvasLayer=i.Class.create(i.Group,{initialize:function(){var t=i.Core.instance;i.Group.call(this),this._cvsCache={matrix:[1,0,0,1,0,0],detectColor:"#000000"},this._cvsCache.layer=this,this.width=t.width,this.height=t.height,this._element=document.createElement("canvas"),this._element.width=t.width,this._element.height=t.height,this._element.style.position="absolute",this._detect=document.createElement("canvas"),this._detect.width=t.width,this._detect.height=t.height,this._detect.style.position="absolute",this._lastDetected=0,this.context=this._element.getContext("2d"),this._dctx=this._detect.getContext("2d"),this._colorManager=new i.DetectColorManager(16,256);var e=[i.Event.TOUCH_START,i.Event.TOUCH_MOVE,i.Event.TOUCH_END];e.forEach(function(t){this.addEventListener(t,function(t){this._scene&&this._scene.dispatchEvent(t)})},this);var n=function(t){var e,r=t.node,a=t.target;e=a instanceof i.CanvasLayer?a._scene._layers.Canvas:a.scene._layers.Canvas,i.CanvasLayer._attachCache(r,e,n,s);var o=new i.Event(i.Event.RENDER);a._dirty&&a._updateCoordinate(),r._dirty=!0,i.Matrix.instance.stack.push(a._matrix),e._rendering(r,o),i.Matrix.instance.stack.pop(a._matrix)},s=function(t){var e,r=t.node,a=t.target;e=a instanceof i.CanvasLayer?a._scene._layers.Canvas:a.scene._layers.Canvas,i.CanvasLayer._detachCache(r,e,n,s)};this.addEventListener("childremoved",s),this.addEventListener("childadded",n)},_startRendering:function(){this.addEventListener("exitframe",this._onexitframe),this._onexitframe(new i.Event(i.Event.RENDER))},_stopRendering:function(){this.removeEventListener("render",this._onexitframe),this._onexitframe(new i.Event(i.Event.RENDER))},_onexitframe:function(){var t=i.Core.instance,e=this.context;e.clearRect(0,0,t.width,t.height);var n=new i.Event(i.Event.RENDER);this._rendering(this,n)},_rendering:function(t,e){var n,s=i.Core.instance,r=i.Matrix.instance,a=(r.stack,t.width),o=t.height,h=this.context;if(h.save(),t.dispatchEvent(e),t.compositeOperation?h.globalCompositeOperation=t.compositeOperation:h.globalCompositeOperation="source-over",h.globalAlpha="number"==typeof t._opacity?t._opacity:1,this._transform(t,h),("undefined"==typeof t._visible||t._visible)&&(t._backgroundColor&&(h.fillStyle=t._backgroundColor,h.fillRect(0,0,a,o)),t.cvsRender&&t.cvsRender(h),s._debug&&(t instanceof i.Label||t instanceof i.Sprite?h.strokeStyle="#ff0000":h.strokeStyle="#0000ff",h.strokeRect(0,0,a,o)),t._clipping&&(h.rect(0,0,a,o),h.clip())),t.childNodes)for(var c=0,d=t.childNodes.length;c<d;c++)n=t.childNodes[c],this._rendering(n,e);h.restore(),i.Matrix.instance.stack.pop()},_detectrendering:function(t){var e,n=t.width,s=t.height,r=this._dctx;if(r.save(),this._transform(t,r),r.fillStyle=t._cvsCache.detectColor,t._touchEnabled&&(t.detectRender?t.detectRender(r):r.fillRect(0,0,n,s)),t._clipping&&(r.rect(0,0,n,s),r.clip()),t.childNodes)for(var a=0,o=t.childNodes.length;a<o;a++)e=t.childNodes[a],this._detectrendering(e);r.restore(),i.Matrix.instance.stack.pop()},_transform:function(t,e){var n,s=i.Matrix.instance,r=s.stack;t._dirty?(s.makeTransformMatrix(t,t._cvsCache.matrix),n=[],s.multiply(r[r.length-1],t._cvsCache.matrix,n),t._matrix=n):n=t._matrix,r.push(n),e.setTransform.apply(e,n);var a="number"==typeof t._originX?t._originX:t._width/2||0,o="number"==typeof t._originY?t._originY:t._height/2||0,h=[a,o];s.multiplyVec(n,h,h),t._offsetX=h[0]-a,t._offsetY=h[1]-o,t._dirty=!1},_determineEventTarget:function(t){return this._getEntityByPosition(t.x,t.y)},_getEntityByPosition:function(t,e){var n=i.Core.instance,s=this._dctx;this._lastDetected<n.frame&&(s.clearRect(0,0,this.width,this.height),this._detectrendering(this),this._lastDetected=n.frame);var r=s.getImageData(t,e,1,1).data;return this._colorManager.getSpriteByColor(r)}}),i.CanvasLayer._attachCache=function(t,e,n,s){var r;if(t._cvsCache||(t._cvsCache={},t._cvsCache.matrix=[1,0,0,1,0,0],t._cvsCache.detectColor="rgba("+e._colorManager.attachDetectColor(t)+")",t.addEventListener("childadded",n),t.addEventListener("childremoved",s)),t.childNodes)for(var a=0,o=t.childNodes.length;a<o;a++)r=t.childNodes[a],i.CanvasLayer._attachCache(r,e,n,s)},i.CanvasLayer._detachCache=function(t,e,n,s){var r;if(t._cvsCache&&(e._colorManager.detachDetectColor(t),t.removeEventListener("childadded",n),t.removeEventListener("childremoved",s),delete t._cvsCache),t.childNodes)for(var a=0,o=t.childNodes.length;a<o;a++)r=t.childNodes[a],i.CanvasLayer._detachCache(r,e,n,s)},i.Scene=i.Class.create(i.Group,{initialize:function(){var t=i.Core.instance;i.Group.call(this),this.width=t.width,this.height=t.height,this.scene=this,this._backgroundColor=null,this._element=document.createElement("div"),this._element.style.width=this.width+"px",this._element.style.height=this.height+"px",this._element.style.position="absolute",this._element.style.overflow="hidden",this._element.style[i.ENV.VENDOR_PREFIX+"TransformOrigin"]="0 0",this._element.style[i.ENV.VENDOR_PREFIX+"Transform"]="scale("+i.Core.instance.scale+")",this._layers={},this._layerPriority=[],this.addEventListener(i.Event.CHILD_ADDED,this._onchildadded),this.addEventListener(i.Event.CHILD_REMOVED,this._onchildremoved),this.addEventListener(i.Event.ENTER,this._onenter),this.addEventListener(i.Event.EXIT,this._onexit);var e=this;this._dispatchExitframe=function(){var t;for(var n in e._layers)t=e._layers[n],t.dispatchEvent(new i.Event(i.Event.EXIT_FRAME))}},x:{get:function(){return this._x},set:function(t){this._x=t;for(var e in this._layers)this._layers[e].x=t}},y:{get:function(){return this._y},set:function(t){this._y=t;for(var e in this._layers)this._layers[e].y=t}},rotation:{get:function(){return this._rotation},set:function(t){this._rotation=t;for(var e in this._layers)this._layers[e].rotation=t}},scaleX:{get:function(){return this._scaleX},set:function(t){this._scaleX=t;for(var e in this._layers)this._layers[e].scaleX=t}},scaleY:{get:function(){return this._scaleY},set:function(t){this._scaleY=t;for(var e in this._layers)this._layers[e].scaleY=t}},backgroundColor:{get:function(){return this._backgroundColor},set:function(t){this._backgroundColor=this._element.style.backgroundColor=t}},addLayer:function(t,e){var n=i.Core.instance;if(!this._layers[t]){var s=new i[t+"Layer"];n.currentScene===this&&s._startRendering(),this._layers[t]=s;var r=s._element;if("number"==typeof e){var a=this._element.childNodes[e];this._element.insertBefore(r,a),this._layerPriority.splice(e,0,t)}else this._element.appendChild(r),this._layerPriority.push(t);s._scene=this}},_determineEventTarget:function(t){for(var e,i,n=this._layerPriority.length-1;n>=0&&(e=this._layers[this._layerPriority[n]],!(i=e._determineEventTarget(t)));n--);return i||(i=this),i},_onchildadded:function(t){var e=t.node,i=t.next;e._element?(this._layers.Dom||this.addLayer("Dom",1),this._layers.Dom.insertBefore(e,i),e._layer=this._layers.Dom):(this._layers.Canvas||this.addLayer("Canvas",0),this._layers.Canvas.insertBefore(e,i),e._layer=this._layers.Canvas),e.parentNode=this},_onchildremoved:function(t){var e=t.node;e._layer.removeChild(e),e._layer=null},_onenter:function(){for(var t in this._layers)this._layers[t]._startRendering();i.Core.instance.addEventListener("exitframe",this._dispatchExitframe)},_onexit:function(){for(var t in this._layers)this._layers[t]._stopRendering();i.Core.instance.removeEventListener("exitframe",this._dispatchExitframe)}}),i.CanvasScene=i.Class.create(i.Scene,{initialize:function(){i.Scene.call(this),this.addLayer("Canvas")},_determineEventTarget:function(t){var e=this._layers.Canvas._determineEventTarget(t);return e||(e=this),e},_onchildadded:function(t){var e=t.node,i=t.next;this._layers.Canvas.insertBefore(e,i),e._layer=this._layers.Canvas},_onenter:function(){this._layers.Canvas._startRendering(),i.Game.instance.addEventListener("exitframe",this._dispatchExitframe)},_onexit:function(){this._layers.Canvas._stopRendering(),i.Game.instance.removeEventListener("exitframe",this._dispatchExitframe)}}),i.DOMScene=i.Class.create(i.Scene,{initialize:function(){i.Scene.call(this),this.addLayer("Dom")},_determineEventTarget:function(t){var e=this._layers.Dom._determineEventTarget(t);return e||(e=this),e},_onchildadded:function(t){var e=t.node,i=t.next;this._layers.Dom.insertBefore(e,i),e._layer=this._layers.Dom},_onenter:function(){this._layers.Dom._startRendering(),i.Game.instance.addEventListener("exitframe",this._dispatchExitframe)},_onexit:function(){this._layers.Dom._stopRendering(),i.Game.instance.removeEventListener("exitframe",this._dispatchExitframe)}}),i.Surface=i.Class.create(i.EventTarget,{initialize:function(t,e){i.EventTarget.call(this);var n=i.Core.instance;this.width=t,this.height=e,this.context=null;var s="enchant-surface"+n._surfaceID++;if(document.getCSSCanvasContext){this.context=document.getCSSCanvasContext("2d",s,t,e),this._element=this.context.canvas,this._css="-webkit-canvas("+s+")";this.context}else document.mozSetImageElement?(this._element=document.createElement("canvas"),this._element.width=t,this._element.height=e,this._css="-moz-element(#"+s+")",this.context=this._element.getContext("2d"),document.mozSetImageElement(s,this._element)):(this._element=document.createElement("canvas"),this._element.width=t,this._element.height=e,this._element.style.position="absolute",this.context=this._element.getContext("2d"),i.ENV.CANVAS_DRAWING_METHODS.forEach(function(t){var e=this.context[t];this.context[t]=function(){e.apply(this,arguments),this._dirty=!0}},this))},getPixel:function(t,e){return this.context.getImageData(t,e,1,1).data},setPixel:function(t,e,i,n,s,r){var a=this.context.createImageData(1,1);a.data[0]=i,a.data[1]=n,a.data[2]=s,a.data[3]=r,this.context.putImageData(a,t,e)},clear:function(){this.context.clearRect(0,0,this.width,this.height)},draw:function(t){if(t=t._element,1===arguments.length)this.context.drawImage(t,0,0);else{var e=arguments;e[0]=t,this.context.drawImage.apply(this.context,e)}},clone:function(){var t=new i.Surface(this.width,this.height);return t.draw(this),t},toDataURL:function(){var t=this._element.src;return t?"data:"===t.slice(0,5)?t:this.clone().toDataURL():this._element.toDataURL()}}),i.Surface.load=function(t,e){var n=new Image,s=Object.create(i.Surface.prototype,{context:{value:null},_css:{value:"url("+t+")"},_element:{value:n}});return i.EventTarget.call(s),n.src=t,n.onerror=function(){throw new Error("Cannot load an asset: "+n.src)},n.onload=function(){s.width=n.width,s.height=n.height,s.dispatchEvent(new i.Event("load"))},s},i.DOMSound=i.Class.create(i.EventTarget,{initialize:function(){throw i.EventTarget.call(this),this.duration=0,new Error("Illegal Constructor")},play:function(){this._element&&this._element.play()},pause:function(){this._element&&this._element.pause()},stop:function(){this.pause(),this.currentTime=0},clone:function(){var t;if(this._element instanceof Audio)t=Object.create(i.DOMSound.prototype,{_element:{value:this._element.cloneNode(!1)},duration:{value:this.duration}});else{if(i.ENV.USE_FLASH_SOUND)return this;t=Object.create(i.DOMSound.prototype)}return i.EventTarget.call(t),t},currentTime:{get:function(){return this._element?this._element.currentTime:0},set:function(t){this._element&&(this._element.currentTime=t)}},volume:{get:function(){return this._element?this._element.volume:1},set:function(t){this._element&&(this._element.volume=t)}}}),i.DOMSound.load=function(e,n,s){if(null==n){var r=i.Core.findExt(e);n=r?"audio/"+r:""}n=n.replace("mp3","mpeg").replace("m4a","mp4");var a=Object.create(i.DOMSound.prototype);i.EventTarget.call(a);var o=new Audio;if(!i.ENV.SOUND_ENABLED_ON_MOBILE_SAFARI&&"webkit"===i.ENV.VENDOR_PREFIX&&i.ENV.TOUCH_ENABLED)t.setTimeout(function(){a.dispatchEvent(new i.Event("load"))},0);else{if(!i.ENV.USE_FLASH_SOUND&&o.canPlayType(n))o.src=e,o.load(),o.autoplay=!1,o.onerror=function(){throw new Error("Cannot load an asset: "+o.src)},o.addEventListener("canplaythrough",function(){a.duration=o.duration,a.dispatchEvent(new i.Event("load"))},!1),a._element=o;else if("audio/mpeg"===n){var h=document.createElement("embed"),c="enchant-audio"+i.Core.instance._soundID++;h.width=h.height=1,h.name=c,h.src="sound.swf?id="+c+"&src="+e,h.allowscriptaccess="always",h.style.position="absolute",h.style.left="-1px",a.addEventListener("load",function(){Object.defineProperties(h,{currentTime:{get:function(){return h.getCurrentTime()},set:function(t){h.setCurrentTime(t)}},volume:{get:function(){return h.getVolume()},set:function(t){h.setVolume(t)}}}),a._element=h,a.duration=h.getDuration()}),i.Core.instance._element.appendChild(h),i.DOMSound[c]=a}else t.setTimeout(function(){a.dispatchEvent(new i.Event("load"))},0);a.addEventListener("load",function(){s.call(i.Core.instance)})}return a},t.AudioContext=t.AudioContext||t.webkitAudioContext||t.mozAudioContext||t.msAudioContext||t.oAudioContext,i.WebAudioSound=i.Class.create(i.EventTarget,{initialize:function(){if(!t.webkitAudioContext)throw new Error("This browser does not support WebAudio API.");var e=i.WebAudioSound.audioContext;i.EventTarget.call(this),this.src=e.createBufferSource(),this.buffer=null,this._volume=1,this._currentTime=0,this._state=0,this.connectTarget=i.WebAudioSound.destination},play:function(t){var e=i.WebAudioSound.audioContext;2===this._state?this.src.connect(this.connectTarget):(1!==this._state||t||this.src.disconnect(this.connectTarget),this.src=e.createBufferSource(),this.src.buffer=this.buffer,this.src.gain.value=this._volume,this.src.connect(this.connectTarget),this.src.noteOn(0)),this._state=1},pause:function(){i.WebAudioSound.audioContext;this.src.disconnect(this.connectTarget),this._state=2},stop:function(){this.src.noteOff(0),this._state=0},clone:function(){var t=new i.WebAudioSound;return t.buffer=this.buffer,t},dulation:{get:function(){return this.buffer?this.buffer.dulation:0}},volume:{get:function(){return this._volume},set:function(t){t=Math.max(0,Math.min(1,t)),this._volume=t,this.src&&(this.src.gain.value=t)}},currentTime:{get:function(){return t.console.log("currentTime is not allowed"),this._currentTime},set:function(e){t.console.log("currentTime is not allowed"),this._currentTime=e}}}),i.WebAudioSound.load=function(e,n,s){var r=i.WebAudioSound.audioContext,a=new XMLHttpRequest,o=new i.WebAudioSound;"audio/"+i.Core.findExt(e);return a.responseType="arraybuffer",a.open("GET",e,!0),a.onload=function(){r.decodeAudioData(a.response,function(t){o.buffer=t,s.call(i.Core.instance)},function(e){t.console.log(e)})},a.send(null),o},t.AudioContext&&(i.WebAudioSound.audioContext=new t.AudioContext,i.WebAudioSound.destination=i.WebAudioSound.audioContext.destination),i.Sound=t.AudioContext&&i.ENV.USE_WEBAUDIO?i.WebAudioSound:i.DOMSound,i.Easing={LINEAR:function(t,e,i,n){return i*t/n+e},SWING:function(t,e,i,n){return i*(.5-Math.cos(t/n*Math.PI)/2)+e},QUAD_EASEIN:function(t,e,i,n){return i*(t/=n)*t+e},QUAD_EASEOUT:function(t,e,i,n){return-i*(t/=n)*(t-2)+e},QUAD_EASEINOUT:function(t,e,i,n){return(t/=n/2)<1?i/2*t*t+e:-i/2*(--t*(t-2)-1)+e},CUBIC_EASEIN:function(t,e,i,n){return i*(t/=n)*t*t+e},CUBIC_EASEOUT:function(t,e,i,n){return i*((t=t/n-1)*t*t+1)+e},CUBIC_EASEINOUT:function(t,e,i,n){return(t/=n/2)<1?i/2*t*t*t+e:i/2*((t-=2)*t*t+2)+e},QUART_EASEIN:function(t,e,i,n){return i*(t/=n)*t*t*t+e},QUART_EASEOUT:function(t,e,i,n){return-i*((t=t/n-1)*t*t*t-1)+e},QUART_EASEINOUT:function(t,e,i,n){return(t/=n/2)<1?i/2*t*t*t*t+e:-i/2*((t-=2)*t*t*t-2)+e},QUINT_EASEIN:function(t,e,i,n){return i*(t/=n)*t*t*t*t+e},QUINT_EASEOUT:function(t,e,i,n){return i*((t=t/n-1)*t*t*t*t+1)+e},QUINT_EASEINOUT:function(t,e,i,n){return(t/=n/2)<1?i/2*t*t*t*t*t+e:i/2*((t-=2)*t*t*t*t+2)+e},SIN_EASEIN:function(t,e,i,n){return-i*Math.cos(t/n*(Math.PI/2))+i+e},SIN_EASEOUT:function(t,e,i,n){return i*Math.sin(t/n*(Math.PI/2))+e},SIN_EASEINOUT:function(t,e,i,n){return-i/2*(Math.cos(Math.PI*t/n)-1)+e},CIRC_EASEIN:function(t,e,i,n){return-i*(Math.sqrt(1-(t/=n)*t)-1)+e},CIRC_EASEOUT:function(t,e,i,n){return i*Math.sqrt(1-(t=t/n-1)*t)+e},CIRC_EASEINOUT:function(t,e,i,n){return(t/=n/2)<1?-i/2*(Math.sqrt(1-t*t)-1)+e:i/2*(Math.sqrt(1-(t-=2)*t)+1)+e},ELASTIC_EASEIN:function(t,e,i,n,s,r){if(0===t)return e;if(1===(t/=n))return e+i;r||(r=.3*n);var a;return!s||s<Math.abs(i)?(s=i,a=r/4):a=r/(2*Math.PI)*Math.asin(i/s),-(s*Math.pow(2,10*(t-=1))*Math.sin((t*n-a)*(2*Math.PI)/r))+e},ELASTIC_EASEOUT:function(t,e,i,n,s,r){if(0===t)return e;if(1===(t/=n))return e+i;r||(r=.3*n);var a;return!s||s<Math.abs(i)?(s=i,a=r/4):a=r/(2*Math.PI)*Math.asin(i/s),s*Math.pow(2,-10*t)*Math.sin((t*n-a)*(2*Math.PI)/r)+i+e},ELASTIC_EASEINOUT:function(t,e,i,n,s,r){if(0===t)return e;if(2===(t/=n/2))return e+i;r||(r=n*(.3*1.5));var a;return!s||s<Math.abs(i)?(s=i,a=r/4):a=r/(2*Math.PI)*Math.asin(i/s),t<1?-.5*(s*Math.pow(2,10*(t-=1))*Math.sin((t*n-a)*(2*Math.PI)/r))+e:s*Math.pow(2,-10*(t-=1))*Math.sin((t*n-a)*(2*Math.PI)/r)*.5+i+e},BOUNCE_EASEOUT:function(t,e,i,n){return(t/=n)<1/2.75?i*(7.5625*t*t)+e:t<2/2.75?i*(7.5625*(t-=1.5/2.75)*t+.75)+e:t<2.5/2.75?i*(7.5625*(t-=2.25/2.75)*t+.9375)+e:i*(7.5625*(t-=2.625/2.75)*t+.984375)+e},BOUNCE_EASEIN:function(t,e,n,s){return n-i.Easing.BOUNCE_EASEOUT(s-t,0,n,s)+e},BOUNCE_EASEINOUT:function(t,e,n,s){return t<s/2?.5*i.Easing.BOUNCE_EASEIN(2*t,0,n,s)+e:.5*i.Easing.BOUNCE_EASEOUT(2*t-s,0,n,s)+.5*n+e},BACK_EASEIN:function(t,i,n,s,r){return r===e&&(r=1.70158),n*(t/=s)*t*((r+1)*t-r)+i},BACK_EASEOUT:function(t,i,n,s,r){return r===e&&(r=1.70158),n*((t=t/s-1)*t*((r+1)*t+r)+1)+i},BACK_EASEINOUT:function(t,i,n,s,r){return r===e&&(r=1.70158),(t/=s/2)<1?n/2*(t*t*(((r*=1.525)+1)*t-r))+i:n/2*((t-=2)*t*(((r*=1.525)+1)*t+r)+2)+i},EXPO_EASEIN:function(t,e,i,n){return 0===t?e:i*Math.pow(2,10*(t/n-1))+e},EXPO_EASEOUT:function(t,e,i,n){return t===n?e+i:i*(-Math.pow(2,-10*t/n)+1)+e},EXPO_EASEINOUT:function(t,e,i,n){return 0===t?e:t===n?e+i:(t/=n/2)<1?i/2*Math.pow(2,10*(t-1))+e:i/2*(-Math.pow(2,-10*--t)+2)+e}},i.ActionEventTarget=i.Class.create(i.EventTarget,{initialize:function(){i.EventTarget.apply(this,arguments)},dispatchEvent:function(t){var e;this.node?(e=this.node,t.target=e,t.localX=t.x-e._offsetX,t.localY=t.y-e._offsetY):this.node=null,null!=this["on"+t.type]&&this["on"+t.type].call(e,t);var i=this._listeners[t.type];if(null!=i){i=i.slice();for(var n=0,s=i.length;n<s;n++)i[n].call(e,t)}}}),i.Timeline=i.Class.create(i.EventTarget,{initialize:function(t){i.EventTarget.call(this),this.node=t,this.queue=[],this.paused=!1,this.looped=!1,this.isFrameBased=!0,this._parallel=null,this._activated=!1,this.addEventListener(i.Event.ENTER_FRAME,this.tick)},_deactivateTimeline:function(){this._activated&&(this._activated=!1,this.node.removeEventListener("enterframe",this._nodeEventListener))},_activateTimeline:function(){this._activated||this.paused||(this.node.addEventListener("enterframe",this._nodeEventListener),this._activated=!0)},setFrameBased:function(){this.isFrameBased=!0},setTimeBased:function(){this.isFrameBased=!1},next:function(t){var e,n=this.queue.shift();if(e=new i.Event("actionend"),e.timeline=this,n.dispatchEvent(e),0===this.queue.length)return this._activated=!1,void this.node.removeEventListener("enterframe",this._nodeEventListener);if(this.looped?(e=new i.Event("removedfromtimeline"),e.timeline=this,n.dispatchEvent(e),n.frame=0,this.add(n)):(e=new i.Event("removedfromtimeline"),e.timeline=this,n.dispatchEvent(e)),t>0||this.queue[0]&&0===this.queue[0].time){var s=new i.Event("enterframe");s.elapsed=t,this.dispatchEvent(s)}},tick:function(t){if(!this.paused&&this.queue.length>0){var e=this.queue[0];if(0===e.frame){var n;n=new i.Event("actionstart"),n.timeline=this,e.dispatchEvent(n)}var s=new i.Event("actiontick");s.timeline=this,this.isFrameBased?s.elapsed=1:s.elapsed=t.elapsed,e.dispatchEvent(s)}},add:function(t){if(!this._activated){var e=this;this._nodeEventListener=function(t){e.dispatchEvent(t)},this.node.addEventListener("enterframe",this._nodeEventListener),this._activated=!0}this._parallel?(this._parallel.actions.push(t),this._parallel=null):this.queue.push(t),t.frame=0;var n=new i.Event("addedtotimeline");return n.timeline=this,t.dispatchEvent(n),n=new i.Event("actionadded"),n.action=t,this.dispatchEvent(n),this},action:function(t){return this.add(new i.Action(t))},tween:function(t){return this.add(new i.Tween(t))},clear:function(){var t=new i.Event("removedfromtimeline");t.timeline=this;for(var e=0,n=this.queue.length;e<n;e++)this.queue[e].dispatchEvent(t);return this.queue=[],this._deactivateTimeline(),this},skip:function(t){var e=new i.Event("enterframe");for(this.isFrameBased?e.elapsed=1:(e.elapsed=t,t=1);t--;)this.dispatchEvent(e);return this},pause:function(){return this.paused||(this.paused=!0,
this._deactivateTimeline()),this},resume:function(){return this.paused&&(this.paused=!1,this._activateTimeline()),this},loop:function(){return this.looped=!0,this},unloop:function(){return this.looped=!1,this},delay:function(t){return this.add(new i.Action({time:t})),this},wait:function(t){return this},then:function(t){var e=this;return this.add(new i.Action({onactiontick:function(i){t.call(e.node)},time:0})),this},exec:function(t){this.then(t)},cue:function(t){var e=0;for(var i in t)t.hasOwnProperty(i)&&(this.delay(i-e),this.then(t[i]),e=i)},repeat:function(t,e){return this.add(new i.Action({onactiontick:function(e){t.call(this)},time:e})),this},and:function(){var t=this.queue.pop();if(t instanceof i.ParallelAction)this._parallel=t,this.queue.push(t);else{var e=new i.ParallelAction;e.actions.push(t),this.queue.push(e),this._parallel=e}return this},or:function(){return this},doAll:function(t){return this},waitAll:function(){return this},waitUntil:function(t){var e=this;return this.add(new i.Action({onactionstart:t,onactiontick:function(i){t.call(this)&&e.next()}})),this},fadeTo:function(t,e,i){return this.tween({opacity:t,time:e,easing:i}),this},fadeIn:function(t,e){return this.fadeTo(1,t,e)},fadeOut:function(t,e){return this.fadeTo(0,t,e)},moveTo:function(t,e,i,n){return this.tween({x:t,y:e,time:i,easing:n})},moveX:function(t,e,i){return this.tween({x:t,time:e,easing:i})},moveY:function(t,e,i){return this.tween({y:t,time:e,easing:i})},moveBy:function(t,e,i,n){return this.tween({x:function(){return this.x+t},y:function(){return this.y+e},time:i,easing:n})},hide:function(){return this.then(function(){this.opacity=0})},show:function(){return this.then(function(){this.opacity=1})},removeFromScene:function(){return this.then(function(){this.scene.removeChild(this)})},scaleTo:function(t,e,i){return"number"==typeof i?this.tween({scaleX:arguments[0],scaleY:arguments[1],time:arguments[2],easing:arguments[3]}):this.tween({scaleX:t,scaleY:t,time:e,easing:i})},scaleBy:function(t,e,i){return"number"==typeof i?this.tween({scaleX:function(){return this.scaleX*arguments[0]},scaleY:function(){return this.scaleY*arguments[1]},time:arguments[2],easing:arguments[3]}):this.tween({scaleX:function(){return this.scaleX*t},scaleY:function(){return this.scaleY*t},time:e,easing:i})},rotateTo:function(t,e,i){return this.tween({rotation:t,time:e,easing:i})},rotateBy:function(t,e,i){return this.tween({rotation:function(){return this.rotation+t},time:e,easing:i})}}),i.Action=i.Class.create(i.ActionEventTarget,{initialize:function(t){i.ActionEventTarget.call(this),this.time=null,this.frame=0;for(var e in t)t.hasOwnProperty(e)&&null!=t[e]&&(this[e]=t[e]);var n=this;this.timeline=null,this.node=null,this.addEventListener(i.Event.ADDED_TO_TIMELINE,function(t){n.timeline=t.timeline,n.node=t.timeline.node,n.frame=0}),this.addEventListener(i.Event.REMOVED_FROM_TIMELINE,function(){n.timeline=null,n.node=null,n.frame=0}),this.addEventListener(i.Event.ACTION_TICK,function(t){var e=n.time-(n.frame+t.elapsed);null!=n.time&&e<=0?(n.frame=n.time,t.timeline.next(-e)):n.frame+=t.elapsed})}}),i.ParallelAction=i.Class.create(i.Action,{initialize:function(t){i.Action.call(this,t);this.timeline,this.node;this.actions=[],this.endedActions=[];var e=this;this.addEventListener(i.Event.ACTION_START,function(t){for(var i=0,n=e.actions.length;i<n;i++)e.actions[i].dispatchEvent(t)}),this.addEventListener(i.Event.ACTION_TICK,function(t){var n,s,r={next:function(t){var r=e.actions[n];e.actions.splice(n--,1),s=e.actions.length,e.endedActions.push(r);var a=new i.Event("actionend");a.timeline=this,r.dispatchEvent(a),a=new i.Event("removedfromtimeline"),a.timeline=this,r.dispatchEvent(a)}},a=new i.Event("actiontick");for(a.timeline=r,a.elapsed=t.elapsed,n=0,s=e.actions.length;n<s;n++)e.actions[n].dispatchEvent(a);0===e.actions.length&&t.timeline.next()}),this.addEventListener(i.Event.ADDED_TO_TIMELINE,function(t){for(var i=0,n=e.actions.length;i<n;i++)e.actions[i].dispatchEvent(t)}),this.addEventListener(i.Event.REMOVED_FROM_TIMELINE,function(){this.actions=this.endedActions,this.endedActions=[]})}}),i.Tween=i.Class.create(i.Action,{initialize:function(t){var e={},n={};i.Action.call(this,t),null==this.easing&&(this.easing=function(t,e,i,n){return i*t/n+e});var s=this;this.addEventListener(i.Event.ACTION_START,function(){var i=["frame","time","callback","onactiontick","onactionstart","onactionend"];for(var r in t)if(t.hasOwnProperty(r)){var a;a="function"==typeof t[r]?t[r].call(s.node):t[r],i.indexOf(r)===-1&&(e[r]=s.node[r],n[r]=a)}}),this.addEventListener(i.Event.ACTION_TICK,function(t){var i=0===s.time?1:s.easing(Math.min(s.time,s.frame+t.elapsed),0,1,s.time)-s.easing(s.frame,0,1,s.time);for(var r in n)if(n.hasOwnProperty(r)){if("undefined"==typeof this[r])continue;s.node[r]+=(n[r]-e[r])*i,Math.abs(s.node[r])<1e-7&&(s.node[r]=0)}})}})}(window);